from typing import Literal
from utils import PUNCTS_STR

PROMPT_1 = (
    "Тебе дано АУДИО и его транскрибация (русский язык): {transcribe}\n"
    "\n"
    "Задача: восстановить пунктуацию для TTS, используя ТОЛЬКО знаки: {puncts}. "
    "Троеточие трактуй как один знак \"...\".\n"
    "\n"
    "Про исходный текст и пунктуацию:\n"
    "• В транскрибации уже могут встречаться знаки — как корректные, так и ошибочные.\n"
    "• Считай их ПОДСКАЗКОЙ, а не истиной. Итог — по аудио (интонация/паузы/энергия).\n"
    "• НЕ переделывай знак без чётких аудио-оснований. При сомнении — сохраняй как в исходнике.\n"
    "\n"
    "Ограничения на изменения текста (строго):\n"
    "• НЕ добавляй и НЕ удаляй слова, НЕ меняй порядок, склонение, форму слов.\n"
    "• Сохраняй РЕГИСТР символов как в исходнике. ИСКЛЮЧЕНИЕ: можно исправить регистр ТОЛЬКО если ты на 100% уверен, "
    "что здесь обязана быть прописная буква (имя собственное, начало предложения) или налицо грубая орфографическая ошибка.\n"
    "\n"
    "Приоритет аудио и эвристики:\n"
    "• Решай по звучанию: контур тона (F0), длительность пауз, ударения, динамика/энергия.\n"
    "1) \"?\" — отчётливый подъём тона в конце либо вопросительная мелодика с короткой финальной паузой.\n"
    "   Если в исходнике \".\"/нет знака, но аудио — явный вопрос, замени на \"?\". Если стоит \"?\", а вопросительной интонации нет — замени на \".\".\n"
    "2) \"!\" — высокая энергия/экспрессия, ударный финал, резкое завершение. Если экспрессии нет — не ставь \"!\".\n"
    "3) \",\" — внутренняя краткая пауза (~150–400 мс) без завершения интонационного контура; перечисления/вводные/обращения.\n"
    "4) \"...\" — заметная пауза (>600–800 мс) и недосказанность/обрыв (нет финального падения). Не путай с точкой.\n"
    "5) \".\" — чёткое завершение мысли с финальным падением тона; базовый выбор при неопределённости.\n"
    "6) \":\" — короткая пауза с «подвешенной» интонацией перед пояснением/перечислением (подготовка к раскрытию/примеру/списку).\n"
    "\n"
    "Консервативность правок:\n"
    "• При малейшем сомнении между изменением и сохранением исходника — СОХРАНЯЙ исходник.\n"
    "• Между \".\" и \"?\"/\"!\" при неуверенности — выбирай \".\" или оставляй исходный знак.\n"
    "• Нормализуй кратные знаки: \"??\" → \"?\", \"!!!\" → \"!\", последовательности точек → \"...\" (если это пауза/обрыв), иначе \".\".\n"
    "\n"
    "Технические требования к выводу:\n"
    "• Используй только {puncts}. Удали все остальные знаки (кавычки, тире и т.п.).\n"
    "• Пробелы: без пробела ПЕРЕД , . ! ? : и один пробел ПОСЛЕ (кроме конца строки); множественные пробелы нормализуй до одного.\n"
    "• Верни ТОЛЬКО результат в теге <out>...</out> без каких-либо комментариев.\n"
)

PROMPT_2 = (
    "Ты — высококвалифицированный краудсорс-разметчик.\n"
    "Твоя задача — отредактировать транскрипт на основе АУДИО и текста ниже.\n"
    "\n"
    "Исходный текст (может содержать пунктуацию и ошибки):\n"
    "{transcript}\n"
    "\n"
    "Требования:\n"
    "1) Расставь пунктуацию и капитализацию по интонации и смыслу аудио (особенно «?», «!»).\n"
    "2) Приведи текст к презентабельному виду (денормализация), не изменяя содержание.\n"
    "3) Если в аудио заметно, что исходный текст содержит ошибки (не совпадает с произнесённым), исправь их.\n"
    "4) Не добавляй слова, которых нет в аудио, и не меняй порядок слов. Если не уверен — оставь как есть.\n"
    "5) Сохраняй вставки на английском языке (например, “thank you”) в оригинальном виде.\n"
    "\n"
    "Верни ТОЛЬКО итоговый текст в теге <out>...</out> без каких-либо комментариев.\n"
)

# Вариант для бенча (на вход — СЛОВА БЕЗ пунктуации)
BENCH_PROMPT = (
    "Тебе дано АУДИО и его транскрибация без пунктуации (русский язык): {transcribe}\n"
    "\n"
    "Задача: восстановить пунктуацию для TTS, используя ТОЛЬКО знаки: {puncts}.\n"
    "Троеточие трактуй как один знак \"...\".\n"
    "\n"
    "Ключевые принципы (ПРИОРИТЕТ АУДИО > текста):\n"
    "• Слушай интонацию, паузы, длительности, ударения, громкость/энергию. Решение о знаке делай по звучанию.\n"
    "• Не добавляй/не удаляй слова, не меняй порядок слов. Разрешена ТОЛЬКО расстановка знаков из списка.\n"
    "• Всегда пиши в нижнем регистре.\n"
    "\n"
    "Эвристики расстановки:\n"
    "1) «?» — явный финальный подъём тона; при сомнении между «.» и «?» выбирай «.».\n"
    "2) «!» — высокая энергия/экспрессия и резкое завершение; при сомнении ставь «.».\n"
    "3) «,» — короткая внутренняя пауза без финального завершения.\n"
    "4) «...» — заметная пауза и недосказанность (нет финального падения).\n"
    "5) «.» — явное завершение мысли с финальным падением тона.\n"
    "6) «:» — «подвешенная» интонация перед пояснением/перечислением.\n"
    "\n"
    "Технические требования:\n"
    "• Пробелы: без пробела перед , . ! ? : и один пробел после; множественные пробелы сжать до одного.\n"
    "• Верни ТОЛЬКО результат в теге <out>...</out> без комментариев.\n"
)

PROMPT_3 = (
    "Ты — высококвалифицированный краудсорс-разметчик.\n"
    "Твоя задача — отредактировать транскрипт по АУДИО и тексту ниже.\n"
    "\n"
    "Исходный текст (может содержать пунктуацию и ошибки):\n"
    "{transcript}\n"
    "\n"
    "Правила:\n"
    "1) Пунктуация и регистр: расставь запятые, точки, тире, «?» и «!» по интонации и смыслу аудио; начальные буквы предложений и имена собственные — с заглавной.\n"
    "2) Содержание и порядок слов: сохраняй исходные слова и их порядок. Ничего не добавляй и не удаляй. Если сомневаешься — оставь как в исходнике.\n"
    "3) Исправления по аудио: исправляй только очевидные ошибки распознавания, когда в аудио явно слышится другой вариант слова/формы.\n"
    "4) Вставки на английском сохраняй без изменений (например, “thank you”).\n"
    "5) Числа и символы: НЕ используй цифры и спецзнаки (%, $, № и т.п.). Пиши числа словами, так как они произнесены. Единицы и валюты — словами (\"процентов\", \"рублей\", \"килограммов\"). Дробные — как слышно (\"три целых пять десятых\" или \"три точка пять\") — без цифр и символов.\n"
    "6) Оформление: используй русские кавычки «…» для прямой речи и цитат; тире — «—» для пауз/самопоправок. Многоточие ставь только при явном затухании и не более одного подряд. Не ставь повторные знаки (вроде \"!!\" или \"?!\").\n"
    "7) Спорные места: если фрагмент неразборчив, оставь исходный вариант без правок.\n"
    "\n"
    "Верни ТОЛЬКО итоговый текст в теге <out>...</out> без каких-либо комментариев.\n"
)

def get_prompt(text: str, version: Literal[1, 2, 3]) -> str:
    if version == 1:
        return PROMPT_1.format(transcribe=text, puncts=PUNCTS_STR)
    elif version == 2:
        return PROMPT_2.format(transcript=text)
    elif version == 3:
        return PROMPT_3.format(transcript=text)
    else:
        raise ValueError("Incorrect PROMPT version!")

def get_bench_prompt(words_only: str) -> str:
    return BENCH_PROMPT.format(transcribe=words_only, puncts=PUNCTS_STR)
